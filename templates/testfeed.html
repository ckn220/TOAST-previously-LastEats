{% extends "skeleton.html" %}

{% block style %}
<meta property="og:image" content="http://beta.lasteats.com/static/assets/img/CURRENT_LOGO_WHITE.png">
<meta name="Description" content="Find the best meals chosen by your friends for cities all over the world.">

<style>
.main-content {
	max-width:none;
	margin: 0px 5%;
}

.inline {
	display:inline-block;
	vertical-align:top;
}
.ui-select .ui-btn {
	padding: 7px;
	font-size: 14px;
	padding-right: 37px;
	margin-right: 10px;
	font-weight: normal;
}
.ui-select, .ui-input-text {
	display: inline-block;
	vertical-align: top;
}

.newsfeedItem {
	display: inline-block;
	float: left;
	width: 30%;
	margin: 0px 1%;
	padding:0px .5%;
}
</style>
{% endblock %} 

{% block body %}

<div data-role="page" class="jqm-demos mainScroller" data-quicklinks="false">
	{% include "header.html" %}
	
	<div role="main" class="ui-content jqm-content main-content" data-ajax-warning="false">
		</br>
		<div style='text-align:left;font-size:14px;margin-bottom:30px;border-bottom:2px solid #ddd;'>
			<h1>Add Last Eats</h1>
			<div>
				<div class='error_message' style='display:none;padding:5px 0px;margin:5px 0px;background:#faa;'></div>
				<div class='inline' style='padding-right:5px;padding-top: 11px;'>If I only had time for one meal in: </div>
				<div class='inline' ><input type="text" name="textinput-4" id="textinput-4" placeholder="Enter a City" value="" style='width:230px;'></div>
				<input type="hidden" id="cityLat" name="cityLat" />
				<input type="hidden" id="cityLng" name="cityLng" />
			</div>
			
			<div>
				<div class='error_message3' style='display:none;padding:5px 0px;margin:5px 0px;background:#faa;'></div>
				<div class='inline' style='padding-right:5px;padding-top: 12px;'>and I wanted </div>
				<div class='inline'>
					<select name="select-choice-1" id="select-choice-1">
						<option value="">Choose a tag</option>
						<optgroup label="Thematic:">
							{% for row in thematic %}
							<option value="{{row}}">{{row}}</option>
							{%endfor%}
						</optgroup>
						<optgroup label='Specific:'>
							{% for row in specific %}
							<option value="{{row}}">{{row}}</option>
							{% endfor %}
						</optgroup>
					</select>
					
					<input id="tag" class="controls" type="text" name='tag' placeholder="or make your own tag!" value="">
				</div> 
			</div>
			
			<div>
				<div class='error_message2' style='display:none;padding:5px 0px;margin:5px 0px;background:#faa;'></div>
				<div class='inline' style='padding-right:5px;padding-top: 11px;'>I'd go to: </div>
				<div class='inline' id="geocode">
					<input id="address" class="controls" type="text" placeholder="Enter a Restaurant" value="" style='width:375px;'>
					<input type="hidden" id="addressName" name="addressName" />
					<input type="hidden" id="addressLat" name="addressLat" />
					<input type="hidden" id="addressLng" name="addressLng" />
				</div> 
			</div>
			
			<div class="form_next"><a data-role="button" style="color: black;display:inline-block;" onclick='moveOn()'>Submit</a></div>
		
		</div>
		
		<div class='newsfeed' style='text-align:left;font-size:14px;'>
			<h1>Recent Declarations</h1>
			
			{% include "newsfeed_content.html"%}
			<div style='clear:both;'></div>
		</div>
		
		{% include "sidebars.html" %}
	</div>
	
</div><!-- /page -->
{% endblock %}

{% block scripts %}
<script src="/static/js/mapquest.js"></script>
<script>
$(document).ready(function(){
	$('#select-choice-1').change(function(){
		if ($(this).val() == '' ){$('#tag').textinput('enable');}
		else{$('#tag').textinput('disable');}
	});
	$('#tag').keyup(function(){
		if ($(this).val() == '' ){$('#select-choice-1').selectmenu('enable');}
		else{$('#select-choice-1').selectmenu('disable');}
	});
	
});

var ajax_loading = 0;
function moveOn(){
	
	if ($('#textinput-4').length > 0){
		var city = $('#textinput-4').val();
	}
	else {
		var city = $('#textinput-5').val();
	}
	var addressName = $('#addressName').val();
	var addressLat = $('#addressLat').val();
	var addressLng = $('#addressLng').val();
	var tag = $('input[name=tag]').val();
	if (tag == ''){
		tag = $('select[name=select-choice-1]').val();
	}
	
	var warned = false;
	if ($('.error_message').css('display') != 'none'){
		warned = true;}
	
	if (addressName == '' || addressLat == '' || addressLng == ''){
		$('.error_message2').html("Sorry we couldn't find that restaurant");
		$('.error_message2').show();
	}
	else if ($('#cityLat').val() == '' && reqId == undefined){
		$('.error_message').html("Sorry we couldn't find that city");
		$('.error_message').show();
	}
	
	else if (ajax_loading == 0){
		$('.form_next a').html('Loading . . . ');
		ajax_loading = 1;
		$.ajax({
			url: 'add_last_eats',
			type: "post",
			data: {'city': city,
					'addressName': addressName,
					'addressLat': addressLat,
					'addressLng': addressLng,
					'tag': tag,
					'requestid': reqId,
					'warned': warned},
			success: function(value) {
				ajax_loading = 0;
				console.log(value);
				if('error' in value && $('.error_message').css('display') == 'none'){
					$('.error_message').html(value.error);
					$('.error_message').show();
					$('.form_next a').html('Tell us more!');
				}
				else{
					window.location.reload();
				}
			},
			error: function(xhr, status, error) {
				console.log(xhr.responseText);
				$('.form_next a').html('Woops we hit an error!');
			}
		});
	}
	
}

{% if req %}
var req = {'lati': {{ req.point.coordinates[1] }},'long': {{ req.point.coordinates[0] }}};
var reqId = "{{ req.id }}";
$("#textinput-4").val("{{ req.full_city }}");
$("#textinput-4").prop('disabled', true);

{% else %}
var reqId = undefined;

{% endif %}

</script>

{% endblock %}


